{% extends 'base.html' %}
{% block title %}Community Forum | Krishi Mitra{% endblock %}
{% block content %}
  <main class="container mx-auto px-4 py-16">
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
      <!-- Hero Section -->
      <div class="relative bg-cover bg-center h-64" style="background-image: url('https://civileats.com/wp-content/uploads/2023/05/230510-black-farmer-fund-food-justice-sovereignty-urban-farming-community-local-food-6-Big-Dream-Farm-credit-Jared-Davis.jpg')">
        <div class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center">
          <h1 class="text-4xl md:text-5xl font-bold text-white text-center">Community Forum</h1>
        </div>
      </div>

  <div class="grid md:grid-cols-3 gap-8 p-6" id="forum-root">
        <!-- Main Content -->
        <section class="md:col-span-2 space-y-6">
          <div class="bg-white rounded-xl shadow p-6">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-2xl font-semibold text-gray-800">Community Feed</h2>
              <a href="{% url 'profile_page' %}#create-post" class="flex items-center text-primary hover:underline">
                <i data-feather="plus-circle" class="mr-2"></i>
                Create Post
              </a>
            </div>

            <!-- Posts List -->
            <div class="space-y-6">
              {% for p in posts %}
                <article class="bg-white rounded-xl border p-4">
                  <div class="flex items-start space-x-3">
                    <div class="w-12 h-12 rounded-full bg-green-100 text-primary flex items-center justify-center font-semibold">
                      {{ p.user.username|first|default:'U' }}
                    </div>
                    <div class="flex-1 min-w-0">
                      <div class="flex items-start justify-between">
                        <div>
                          <h3 class="font-semibold text-gray-900">{{ p.user.username }}</h3>
                          <p class="text-xs text-gray-500">{{ p.created_at|date:'M d, Y H:i' }}</p>
                        </div>
                      </div>
                      {% if p.content %}
                        <p class="text-gray-800 mt-2 whitespace-pre-line">{{ p.content }}</p>
                      {% endif %}
                      {% if p.image %}
                        <div class="mt-3 border rounded overflow-hidden">
                          <img src="{{ p.image.url }}" alt="Post image" class="w-full">
                        </div>
                      {% endif %}

                      <!-- Vote bar -->
                      <div class="mt-4 flex items-center gap-3 text-sm">
                        <button class="px-3 py-1 rounded-full border flex items-center gap-1 hover:bg-green-50 vote-btn"
                                data-post-id="{{ p.id }}" data-action="up">
                          <i data-feather="thumbs-up" class="w-4 h-4"></i>
                          <span class="vote-up-{{ p.id }}">{{ p.upvotes|default:0 }}</span>
                        </button>
                        <button class="px-3 py-1 rounded-full border flex items-center gap-1 hover:bg-red-50 vote-btn"
                                data-post-id="{{ p.id }}" data-action="down">
                          <i data-feather="thumbs-down" class="w-4 h-4"></i>
                          <span class="vote-down-{{ p.id }}">{{ p.downvotes|default:0 }}</span>
                        </button>
                        <span class="text-gray-500">Score: <span class="vote-score-{{ p.id }}">{{ p.score|default:0 }}</span></span>
                      </div>

                      <!-- Comments (YouTube-style) -->
                      <div class="mt-4">
                        <div class="flex items-center justify-between">
                          <h4 class="text-sm font-semibold text-gray-800">
                            <span class="comment-count-{{ p.id }}">{{ p.comments_count }}</span> Comments
                          </h4>
                          <button class="text-sm text-gray-600 hover:text-primary toggle-comments" data-post-id="{{ p.id }}">Hide comments</button>
                        </div>

                        <!-- New comment input -->
                        <div class="mt-3 flex items-start gap-3">
                          <div class="w-8 h-8 rounded-full bg-green-100 text-primary flex items-center justify-center text-xs font-semibold">
                            {{ request.user.username|first|default:'U' }}
                          </div>
                          <form class="flex-1 comment-form" data-post-id="{{ p.id }}">
                            {% csrf_token %}
                            <div class="border-b pb-2">
                              <input type="text" name="text" placeholder="Add a comment..." class="w-full outline-none text-sm py-1" />
                            </div>
                            <div class="mt-2 flex items-center gap-2 justify-end">
                              <button type="button" class="px-3 py-1 rounded-full text-sm text-gray-600 hover:bg-gray-100 comment-cancel hidden">Cancel</button>
                              <button class="px-3 py-1.5 rounded-full text-sm bg-gray-200 text-gray-500 comment-submit" disabled>Comment</button>
                            </div>
                          </form>
                        </div>

                        <!-- Existing comments list -->
                        <div class="mt-4 comments-container" data-post-id="{{ p.id }}">
                          <ul class="space-y-4 comments-list" data-post-id="{{ p.id }}">
                            {% for c in p.comments.all %}
                              <li class="flex items-start gap-3 {% if forloop.counter > 3 %}hidden extra{% endif %}" data-comment-id="{{ c.id }}">
                                <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-semibold text-gray-600">
                                  {{ c.user.username|first|default:'U' }}
                                </div>
                                <div class="flex-1">
                                  <div class="text-sm"><span class="font-semibold">{{ c.user.username }}</span> <span class="text-xs text-gray-500">• {{ c.created_at|date:'M d, Y H:i' }}</span></div>
                                  <div class="text-sm text-gray-800 mt-0.5">{{ c.text }}</div>
                                  <div class="flex items-center gap-4 mt-1 text-xs text-gray-500">
                                    <button class="flex items-center gap-1 comment-like-btn {% if c.id in my_comment_likes %}text-primary{% endif %}" data-comment-id="{{ c.id }}" type="button">
                                      <i data-feather="thumbs-up" class="w-3 h-3"></i>
                                      <span class="comment-like-count-{{ c.id }}">{{ c.likes_count|default:0 }}</span>
                                    </button>
                                    <button class="comment-reply-toggle" data-comment-id="{{ c.id }}" type="button">Reply</button>
                                  </div>
                                  <!-- Reply form (hidden by default) -->
                                  <form class="mt-2 hidden reply-form" data-post-id="{{ p.id }}" data-parent-id="{{ c.id }}">
                                    {% csrf_token %}
                                    <div class="border-b pb-2">
                                      <input type="text" name="text" placeholder="Write a reply..." class="w-full outline-none text-sm py-1" />
                                    </div>
                                    <div class="mt-2 flex items-center gap-2 justify-end">
                                      <button type="button" class="px-3 py-1 rounded-full text-sm text-gray-600 hover:bg-gray-100 reply-cancel">Cancel</button>
                                      <button class="px-3 py-1.5 rounded-full text-sm bg-gray-200 text-gray-500 reply-submit" disabled>Reply</button>
                                    </div>
                                  </form>
                                  <!-- Replies list -->
                                  {% if c.replies.all %}
                                    <ul class="mt-3 space-y-3 ml-8 replies-list" data-parent-id="{{ c.id }}">
                                      {% for r in c.replies.all %}
                                        <li class="flex items-start gap-3" data-comment-id="{{ r.id }}">
                                          <div class="w-7 h-7 rounded-full bg-gray-100 flex items-center justify-center text-[10px] font-semibold text-gray-600">{{ r.user.username|first|default:'U' }}</div>
                                          <div class="flex-1">
                                            <div class="text-xs"><span class="font-semibold">{{ r.user.username }}</span> <span class="text-[10px] text-gray-500">• {{ r.created_at|date:'M d, Y H:i' }}</span></div>
                                            <div class="text-sm text-gray-800 mt-0.5">{{ r.text }}</div>
                                            <div class="flex items-center gap-3 mt-1 text-[11px] text-gray-500">
                                              <button class="flex items-center gap-1 comment-like-btn {% if r.id in my_comment_likes %}text-primary{% endif %}" data-comment-id="{{ r.id }}" type="button">
                                                <i data-feather="thumbs-up" class="w-3 h-3"></i>
                                                <span class="comment-like-count-{{ r.id }}">{{ r.likes_count|default:0 }}</span>
                                              </button>
                                            </div>
                                          </div>
                                        </li>
                                      {% endfor %}
                                    </ul>
                                  {% else %}
                                    <ul class="mt-3 space-y-3 ml-8 replies-list" data-parent-id="{{ c.id }}"></ul>
                                  {% endif %}
                                </div>
                              </li>
                            {% empty %}
                              <li class="text-sm text-gray-500">No comments yet.</li>
                            {% endfor %}
                          </ul>
                          {% if p.comments_count and p.comments_count > 3 %}
                            <button class="mt-2 text-sm text-gray-600 hover:text-primary show-more-comments" data-post-id="{{ p.id }}">Show more comments</button>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </div>
                </article>
              {% empty %}
                <div class="bg-gray-50 rounded-xl p-8 text-center">
                  <i data-feather="frown" class="w-12 h-12 mx-auto text-gray-400 mb-4"></i>
                  <h3 class="text-lg font-medium text-gray-600">No posts yet</h3>
                  <p class="text-gray-500 mt-2">Be the first to share your farming experiences!</p>
                  <a href="{% url 'profile_page' %}#create-post" class="mt-4 inline-flex items-center px-4 py-2 bg-primary text-white rounded-full hover:bg-opacity-90 transition">
                    <i data-feather="plus" class="mr-2 w-4 h-4"></i>
                    Create Post
                  </a>
                </div>
              {% endfor %}
            </div>
          </div>
        </section>

        <!-- Sidebar -->
        <aside class="space-y-6">
          <!-- Popular Topics -->
          <div class="bg-white rounded-xl shadow p-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Popular Topics</h3>
            <ul class="space-y-3">
              {% if popular %}
                {% for t in popular %}
                  <li>
                    <div class="flex items-center p-3 hover:bg-gray-50 rounded-lg transition">
                      <span class="w-8 h-8 rounded-full bg-green-100 text-primary flex items-center justify-center mr-3">
                        <i data-feather="hash" class="w-4 h-4"></i>
                      </span>
                      <span class="font-medium">{{ t }}</span>
                    </div>
                  </li>
                {% endfor %}
              {% else %}
                <li>
                  <div class="flex items-center p-3 hover:bg-gray-50 rounded-lg transition">
                    <span class="w-8 h-8 rounded-full bg-green-100 text-primary flex items-center justify-center mr-3">
                      <i data-feather="hash" class="w-4 h-4"></i>
                    </span>
                    <span class="font-medium">Organic Farming</span>
                  </div>
                </li>
                <li>
                  <div class="flex items-center p-3 hover:bg-gray-50 rounded-lg transition">
                    <span class="w-8 h-8 rounded-full bg-green-100 text-primary flex items-center justify-center mr-3">
                      <i data-feather="hash" class="w-4 h-4"></i>
                    </span>
                    <span class="font-medium">Crop Rotation</span>
                  </div>
                </li>
                <li>
                  <div class="flex items-center p-3 hover:bg-gray-50 rounded-lg transition">
                    <span class="w-8 h-8 rounded-full bg-green-100 text-primary flex items-center justify-center mr-3">
                      <i data-feather="hash" class="w-4 h-4"></i>
                    </span>
                    <span class="font-medium">Soil Health</span>
                  </div>
                </li>
              {% endif %}
            </ul>
          </div>

          <!-- Community Guidelines -->
          <div class="bg-white rounded-xl shadow p-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Community Guidelines</h3>
            <ul class="space-y-3 text-sm text-gray-600">
              <li class="flex items-start">
                <i data-feather="check-circle" class="text-primary mr-2 mt-1 flex-shrink-0"></i>
                <span>Be respectful to all community members</span>
              </li>
              <li class="flex items-start">
                <i data-feather="check-circle" class="text-primary mr-2 mt-1 flex-shrink-0"></i>
                <span>Share only farming-related content</span>
              </li>
              <li class="flex items-start">
                <i data-feather="check-circle" class="text-primary mr-2 mt-1 flex-shrink-0"></i>
                <span>No promotional or spam posts</span>
              </li>
              <li class="flex items-start">
                <i data-feather="check-circle" class="text-primary mr-2 mt-1 flex-shrink-0"></i>
                <span>Provide helpful and accurate information</span>
              </li>
            </ul>
          </div>

          <!-- Trending Experts (static placeholders) -->
          <div class="bg-white rounded-xl shadow p-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Trending Experts</h3>
            <ul class="space-y-4">
              <li class="flex items-center">
                <div class="w-10 h-10 rounded-full bg-gray-200 mr-3"></div>
                <div>
                  <h4 class="font-medium">Dr. Agriculture Expert</h4>
                  <p class="text-xs text-gray-500">Soil Scientist</p>
                </div>
                <span class="ml-auto text-xs bg-primary text-white px-3 py-1 rounded-full">Following soon</span>
              </li>
              <li class="flex items-center">
                <div class="w-10 h-10 rounded-full bg-gray-200 mr-3"></div>
                <div>
                  <h4 class="font-medium">Dr. Crop Specialist</h4>
                  <p class="text-xs text-gray-500">Agronomist</p>
                </div>
                <span class="ml-auto text-xs bg-primary text-white px-3 py-1 rounded-full">Following soon</span>
              </li>
              <li class="flex items-center">
                <div class="w-10 h-10 rounded-full bg-gray-200 mr-3"></div>
                <div>
                  <h4 class="font-medium">Dr. Plant Pathologist</h4>
                  <p class="text-xs text-gray-500">Plant Doctor</p>
                </div>
                <span class="ml-auto text-xs bg-primary text-white px-3 py-1 rounded-full">Following soon</span>
              </li>
            </ul>
          </div>
        </aside>
      </div>
    </div>
  </main>
  <script>
    // CSRF helper copied pattern
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Handle voting
    document.querySelectorAll('.vote-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        const postId = btn.getAttribute('data-post-id');
        const action = btn.getAttribute('data-action');
        try {
          const res = await fetch('{% url "forum_vote" %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            body: new URLSearchParams({ post_id: postId, action })
          });
          const data = await res.json();
          if (data.ok) {
            document.querySelector(`.vote-up-${postId}`).textContent = data.upvotes;
            document.querySelector(`.vote-down-${postId}`).textContent = data.downvotes;
            document.querySelector(`.vote-score-${postId}`).textContent = data.score;
          }
        } catch (err) { console.error(err); }
      });
    });

    // Handle comments
    document.querySelectorAll('.comment-form').forEach(form => {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const postId = form.getAttribute('data-post-id');
        const input = form.querySelector('input[name="text"]');
        const submitBtn = form.querySelector('.comment-submit');
        const cancelBtn = form.querySelector('.comment-cancel');
        const text = (input.value || '').trim();
        if (!text) return;
        submitBtn.disabled = true;
        try {
          const res = await fetch('{% url "forum_comment" %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            body: new URLSearchParams({ post_id: postId, text })
          });
          const data = await res.json();
          if (data.ok) {
            const ul = document.querySelector(`.comments-list[data-post-id='${postId}']`);
            const li = document.createElement('li');
            li.className = 'flex items-start gap-3';
            li.setAttribute('data-comment-id', String(data.comment.id));
            li.innerHTML = `
              <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-semibold text-gray-600">${data.comment.user[0]?.toUpperCase() || 'U'}</div>
              <div class="flex-1">
                <div class="text-sm"><span class="font-semibold">${data.comment.user}</span> <span class="text-xs text-gray-500">• ${data.comment.created_at}</span></div>
                <div class="text-sm text-gray-800 mt-0.5">${data.comment.text}</div>
                <div class="flex items-center gap-4 mt-1 text-xs text-gray-500">
                  <button class="flex items-center gap-1 comment-like-btn" data-comment-id="${data.comment.id}" type="button">
                    <i data-feather="thumbs-up" class="w-3 h-3"></i>
                    <span class="comment-like-count-${data.comment.id}">0</span>
                  </button>
                  <button class="comment-reply-toggle" data-comment-id="${data.comment.id}" type="button">Reply</button>
                </div>
                <form class="mt-2 hidden reply-form" data-post-id="${postId}" data-parent-id="${data.comment.id}">
                  <div class="border-b pb-2">
                    <input type="text" name="text" placeholder="Write a reply..." class="w-full outline-none text-sm py-1" />
                  </div>
                  <div class="mt-2 flex items-center gap-2 justify-end">
                    <button type="button" class="px-3 py-1 rounded-full text-sm text-gray-600 hover:bg-gray-100 reply-cancel">Cancel</button>
                    <button class="px-3 py-1.5 rounded-full text-sm bg-gray-200 text-gray-500 reply-submit" disabled>Reply</button>
                  </div>
                </form>
                <ul class="mt-3 space-y-3 ml-8 replies-list" data-parent-id="${data.comment.id}"></ul>
              </div>`;
            ul.prepend(li);
            // increment count
            const countEl = document.querySelector(`.comment-count-${postId}`);
            if (countEl) countEl.textContent = (parseInt(countEl.textContent || '0', 10) + 1).toString();
            input.value = '';
            cancelBtn?.classList.add('hidden');
            feather && feather.replace();
            // bind new buttons & forms
            bindCommentLikeButtons(li.querySelectorAll('.comment-like-btn'));
            bindReplyToggles(li.querySelectorAll('.comment-reply-toggle'));
            bindReplyForms(li.querySelectorAll('.reply-form'));
          }
        } catch (err) { console.error(err); }
        finally { submitBtn.disabled = false; }
      });
      // Enable/disable submit like YouTube
      const input = form.querySelector('input[name="text"]');
      const submitBtn = form.querySelector('.comment-submit');
      const cancelBtn = form.querySelector('.comment-cancel');
      input?.addEventListener('input', () => {
        const hasText = (input.value || '').trim().length > 0;
        submitBtn.disabled = !hasText;
        if (hasText) {
          cancelBtn?.classList.remove('hidden');
          submitBtn.classList.remove('bg-gray-200','text-gray-500');
          submitBtn.classList.add('bg-primary','text-white');
        } else {
          cancelBtn?.classList.add('hidden');
          submitBtn.classList.add('bg-gray-200','text-gray-500');
          submitBtn.classList.remove('bg-primary','text-white');
        }
      });
      cancelBtn?.addEventListener('click', () => {
        input.value = '';
        input.dispatchEvent(new Event('input'));
      });
    });

    // Show more comments toggle
    document.querySelectorAll('.show-more-comments').forEach(btn => {
      btn.addEventListener('click', () => {
        const postId = btn.getAttribute('data-post-id');
        const list = document.querySelector(`.comments-list[data-post-id='${postId}']`);
        list?.querySelectorAll('.extra').forEach(el => el.classList.toggle('hidden'));
        btn.textContent = btn.textContent.includes('more') ? 'Show fewer comments' : 'Show more comments';
      });
    });

    // Toggle comments container show/hide
    document.querySelectorAll('.toggle-comments').forEach(btn => {
      btn.addEventListener('click', () => {
        const postId = btn.getAttribute('data-post-id');
        const container = document.querySelector(`.comments-container[data-post-id='${postId}']`);
        if (!container) return;
        const hidden = container.classList.toggle('hidden');
        btn.textContent = hidden ? 'Show comments' : 'Hide comments';
      });
    });

    // Bind comment like buttons
    function bindCommentLikeButtons(btns) {
      btns.forEach(btn => {
        btn.addEventListener('click', async () => {
          const commentId = btn.getAttribute('data-comment-id');
          try {
            const res = await fetch('{% url "forum_comment_like" %}', {
              method: 'POST',
              headers: { 'X-CSRFToken': csrftoken },
              body: new URLSearchParams({ comment_id: commentId })
            });
            const data = await res.json();
            if (data.ok) {
              const countEl = document.querySelector(`.comment-like-count-${commentId}`);
              if (countEl) countEl.textContent = String(data.likes);
              btn.classList.toggle('text-primary', !!data.liked);
              feather && feather.replace();
            }
          } catch (e) { console.error(e); }
        });
      });
    }
    bindCommentLikeButtons(document.querySelectorAll('.comment-like-btn'));

    // Bind reply toggles
    function bindReplyToggles(toggles) {
      toggles.forEach(t => {
        t.addEventListener('click', () => {
          const commentId = t.getAttribute('data-comment-id');
          const form = document.querySelector(`.reply-form[data-parent-id='${commentId}']`);
          if (!form) return;
          form.classList.toggle('hidden');
        });
      });
    }
    bindReplyToggles(document.querySelectorAll('.comment-reply-toggle'));

    // Bind reply forms
    function bindReplyForms(forms) {
      forms.forEach(form => {
        const input = form.querySelector('input[name="text"]');
        const submitBtn = form.querySelector('.reply-submit');
        const cancelBtn = form.querySelector('.reply-cancel');
        input?.addEventListener('input', () => {
          const has = (input.value || '').trim().length > 0;
          submitBtn.disabled = !has;
          if (has) {
            submitBtn.classList.remove('bg-gray-200','text-gray-500');
            submitBtn.classList.add('bg-primary','text-white');
          } else {
            submitBtn.classList.add('bg-gray-200','text-gray-500');
            submitBtn.classList.remove('bg-primary','text-white');
          }
        });
        cancelBtn?.addEventListener('click', () => {
          input.value = '';
          form.classList.add('hidden');
          input.dispatchEvent(new Event('input'));
        });
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const postId = form.getAttribute('data-post-id');
          const parentId = form.getAttribute('data-parent-id');
          const text = (input.value || '').trim();
          if (!text) return;
          submitBtn.disabled = true;
          try {
            const res = await fetch('{% url "forum_comment" %}', {
              method: 'POST',
              headers: { 'X-CSRFToken': csrftoken },
              body: new URLSearchParams({ post_id: postId, parent_id: parentId, text })
            });
            const data = await res.json();
            if (data.ok) {
              const repliesUl = document.querySelector(`.replies-list[data-parent-id='${parentId}']`);
              const li = document.createElement('li');
              li.className = 'flex items-start gap-3';
              li.setAttribute('data-comment-id', String(data.comment.id));
              li.innerHTML = `
                <div class="w-7 h-7 rounded-full bg-gray-100 flex items-center justify-center text-[10px] font-semibold text-gray-600">${data.comment.user[0]?.toUpperCase() || 'U'}</div>
                <div class="flex-1">
                  <div class="text-xs"><span class="font-semibold">${data.comment.user}</span> <span class="text-[10px] text-gray-500">• ${data.comment.created_at}</span></div>
                  <div class="text-sm text-gray-800 mt-0.5">${data.comment.text}</div>
                  <div class="flex items-center gap-3 mt-1 text-[11px] text-gray-500">
                    <button class="flex items-center gap-1 comment-like-btn" data-comment-id="${data.comment.id}" type="button">
                      <i data-feather='thumbs-up' class="w-3 h-3"></i>
                      <span class="comment-like-count-${data.comment.id}">0</span>
                    </button>
                  </div>
                </div>`;
              repliesUl?.appendChild(li);
              // increment the post's total comment count as replies are counted
              const countEl = document.querySelector(`.comment-count-${postId}`);
              if (countEl) countEl.textContent = (parseInt(countEl.textContent || '0', 10) + 1).toString();
              input.value = '';
              form.classList.add('hidden');
              feather && feather.replace();
              bindCommentLikeButtons(li.querySelectorAll('.comment-like-btn'));
            }
          } catch (err) { console.error(err); }
          finally { submitBtn.disabled = false; }
        });
      });
    }
    bindReplyForms(document.querySelectorAll('.reply-form'));
  </script>
{% endblock %}
